name: "Free Disk Space"
description: "Free up disk space on GitHub runners by removing unnecessary files"
inputs:
  platform:
    description: "Target platform (linux or windows)"
    required: true
    default: "linux"
  aggressive:
    description: "Whether to perform aggressive cleanup"
    required: false
    default: "false"

runs:
  using: "composite"
  steps:
    - name: Free up disk space (Linux)
      if: inputs.platform == 'linux'
      shell: bash
      run: |
        echo "ðŸ§¹ Starting disk cleanup for Linux..."

        # Remove large packages
        if [ "${{ inputs.aggressive }}" == "true" ]; then
            sudo apt-get remove -y '^dotnet-.*' '^llvm-.*' 'php.*' 'mongodb.*' 'mysql.*' 'postgresql.*' || true
        fi

        # Remove directories
        sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc /opt/hostedtoolcache/CodeQL /usr/local/share/boost

        # Clean package cache
        sudo apt-get clean
        sudo rm -rf /var/lib/apt/lists/*
        sudo rm -rf /var/cache/apt/*

        # Docker cleanup
        docker system prune -af

        # Show disk space
        echo "ðŸ“Š Disk space after cleanup:"
        df -h

    - name: Free up disk space (Windows)
      if: inputs.platform == 'windows'
      shell: pwsh
      run: |
        Write-Host "ðŸ§¹ Starting disk cleanup for Windows..."

        # Show initial space
        Get-PSDrive

        # Remove large directories
        Remove-Item -Path "C:\Program Files\dotnet" -Recurse -Force -ErrorAction SilentlyContinue
        Remove-Item -Path "C:\Program Files (x86)\Android" -Recurse -Force -ErrorAction SilentlyContinue
        Remove-Item -Path "C:\ghc" -Recurse -Force -ErrorAction SilentlyContinue
        Remove-Item -Path "C:\hostedtoolcache\CodeQL" -Recurse -Force -ErrorAction SilentlyContinue

        if ("${{ inputs.aggressive }}" -eq "true") {
          Remove-Item -Path "C:\Program Files\Microsoft Visual Studio\2022\Enterprise\Common7\IDE\Extensions" -Recurse -Force -ErrorAction SilentlyContinue
        }

        # Show final space
        Write-Host "ðŸ“Š Disk space after cleanup:"
        Get-PSDrive

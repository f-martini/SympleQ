name: "Version Injection"
description: "Replace dynamic version with static version in pyproject.toml"
inputs:
  fallback-version:
    description: "Fallback version if SCM detection fails"
    required: false
    default: "0.0.0.dev0"
  version-scheme:
    description: "Version scheme for setuptools-scm"
    required: false
    default: "post-release"
  local-scheme:
    description: "Local scheme for setuptools-scm"
    required: false
    default: "node-and-date"

outputs:
  version:
    description: "The injected version"
    value: ${{ steps.inject.outputs.version }}

runs:
  using: "composite"
  steps:
    - name: Install setuptools-scm (Linux/macOS)
      if: runner.os != 'Windows'
      shell: bash
      run: python -m pip install setuptools-scm

    - name: Install setuptools-scm (Windows)
      if: runner.os == 'Windows'
      shell: pwsh
      run: python -m pip install setuptools-scm

    - name: Inject version (Linux/macOS)
      if: runner.os != 'Windows'
      id: inject-unix
      shell: bash
      run: |
        python "${{ github.action_path }}/inject_version.py" \
          --version-scheme "${{ inputs.version-scheme }}" \
          --local-scheme "${{ inputs.local-scheme }}" \
          --fallback-version "${{ inputs.fallback-version }}" \
          >> $GITHUB_OUTPUT

    - name: Inject version (Windows)
      if: runner.os == 'Windows'
      id: inject-windows
      shell: pwsh
      run: |
        $scriptPath = "${{ github.action_path }}/inject_version.py" -replace '/', '\'
        python $scriptPath `
          --version-scheme "${{ inputs.version-scheme }}" `
          --local-scheme "${{ inputs.local-scheme }}" `
          --fallback-version "${{ inputs.fallback-version }}" `
          | Add-Content $env:GITHUB_OUTPUT

    - name: Set output
      id: inject
      shell: bash
      run: |
        if [ "${{ runner.os }}" = "Windows" ]; then
          echo "version=${{ steps.inject-windows.outputs.version }}" >> $GITHUB_OUTPUT
        else
          echo "version=${{ steps.inject-unix.outputs.version }}" >> $GITHUB_OUTPUT
        fi
